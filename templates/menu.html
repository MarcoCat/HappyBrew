{% extends "base.html" %} {% block title %}Menu{% endblock %} {% block content
%}
<main>
  <div class="menucustomPage">
    <section class="menucustomNavBar">
      <h1 class="menuTitile">Menu</h1>     
      {% for category in categories %}
      <h3><a href="#{{ category }}">| {{ category|capitalize }}</a></h3>
      {% endfor %}
    </section>

    <section class="menuItem">
      <p>Enjoy your time!</p>
      {% for category in categories %}
      <h2 id="{{ category }}">{{ category|capitalize }}</h2>
      <ul class="itemType">
        {% for product in products[category] %}
        <li>
          <img
            src="{{ url_for('static', filename='image/menuPage/' + product.name + '.png') }}"
            alt="{{ product.name }} images"
            width="200"
            height="230"
            onerror="this.onerror=null;this.src='{{ url_for('static', filename='image/menuPage/placeholder.png') }}';"
          />
          <h3>{{ product.name }}</h3>
          <p>{{ product.description }}</p>
          <p>Price: {{ product.price }}</p>
          <div class="quantity">
            <button
              class="removeButton"
              type="button"
              onclick="subtractOne(this)"
            >
              -
            </button>
            <input class="count" type="number" value="0" readonly />
            <button class="addButton" type="button" onclick="addOne(this)">
              +
            </button>
          </div>
        </li>
        {% endfor %}
      </ul>
      {% endfor %}
      <div class="orderForm">
        <label for="name">Name:</label>
        <input id="name" type="text" placeholder="Enter your name" {% if session.get('username') %}value="{{ session['username'] }}" readonly{% endif %} />
        <label for="address">Address:</label>
        <input id="address" type="text" placeholder="Enter your address" />
      </div>
      <button class="orderButton" type="button" onclick="submitOrder()">
      <input id="authStatus" type="hidden" value="{% if current_user.is_authenticated %}true{% else %}false{% endif %}">
        Order
      </button>
    </section>
  </div>
</main>

<script>
  function subtractOne(button) {
    var input = button.nextElementSibling;
    var value = parseInt(input.value);
    if (value >= 1) {
      input.value = value - 1;
    }
  }

  function addOne(button) {
    var input = button.previousElementSibling;
    var value = parseInt(input.value);
    input.value = value + 1;
  }

  function getOrderSummary() {
    var orderSummary = {};

    var name = document.getElementById("name").value;
    var address = document.getElementById("address").value;
    orderSummary.name = name;
    orderSummary.address = address;
    orderSummary.products = {};

    var categories = document
      .getElementsByClassName("menuItem")[0]
      .getElementsByTagName("h2");

    for (var i = 0; i < categories.length; i++) {
      var category = categories[i];
      var categoryName = category.id;
      var itemsContainer = category.nextElementSibling;
      var items = itemsContainer.querySelectorAll(".itemType li");

      for (var j = 0; j < items.length; j++) {
        var item = items[j];
        var itemName = item.getElementsByTagName("h3")[0].textContent;
        var countInput = item.getElementsByClassName("count")[0];
        var itemCount = parseInt(countInput.value);

        if (itemCount > 0) {
          if (!orderSummary.products[categoryName]) {
            orderSummary.products[categoryName] = [];
          }

          orderSummary.products[categoryName].push({
            name: itemName,
            count: itemCount,
          });
        }
      }
    }

    return JSON.stringify(orderSummary);
  }

 
  async function submitOrder() {
  const order_summary = getOrderSummary();
  const authStatus = document.getElementById("authStatus").value;

  if (authStatus === "false") {
    alert("Login required. Please log in first.");
    return;
  }

  try {
    const response = await fetch("/order", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(order_summary),
    });

    if (response.ok) {
      alert("Thank you for your ordering!");
      const data = await response.json();
      window.location.href = data.location;
    } else {
      const errorData = await response.json();
      alert(errorData.error);
    }
  } catch (error) {
    console.error("Error ordering:", error);
  }
}

</script>

{% endblock %}
