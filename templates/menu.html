{% extends "base.html" %} 

{% block title %}Menu{% endblock %}

{% block content %}
<main>
  <div class="menuPage">
    <section class="menuNavBar">
      <h1 class="menuTitile">Menu</h1>
      {% for category in categories %}
      <h3><a href="#{{ category }}">| {{ category|capitalize }}</a></h3>
      {% endfor %}
    </section>
    <section class="menuItem">
      <p>Enjoy your time!</p>
      {% for category in categories %}
      <h2 id="{{ category }}">{{ category|capitalize }}</h2>
      <ul class="itemType">
        {% for product in products[category] %}
        <li>
          <img 
            src="{{ url_for('static', filename='image/menuPage/' + product.name + '.png') }}"
            alt="{{ product.name }} images"
            width="200"
            height="230"
            onerror="this.onerror=null;this.src='{{ url_for('static', filename='image/menuPage/placeholder.png') }}';"
          />
          <h3>{{ product.name }}</h3>
          <p>{{ product.description }}</p>
          <p>Price: {{ product.price }}</p>
          <div class="quantity">
            <button class="removeButton" type="button" onclick="subtractOne(this)">-</button>
            <input class="count" type="number" value="0" readonly>
            <button class="addButton" type="button" onclick="addOne(this)">+</button>
          </div>
        </li>
        {% endfor %}
      </ul>
      {% endfor %}
      <button class="orderButton" type="button" onclick="submitOrder()">Order</button>
    </section>
  </div>
</main>

<script>
  function subtractOne(button) {
    var input = button.nextElementSibling;
    var value = parseInt(input.value);
    if (value >= 1) {
      input.value = value - 1;
    }
  }

  function addOne(button) {
    var input = button.previousElementSibling;
    var value = parseInt(input.value);
    input.value = value + 1;
  }

  function getOrderSummary() {
  var orderSummary = {};

  var categories = document.getElementsByClassName('menuItem')[0].getElementsByTagName('h2');

  for (var i = 0; i < categories.length; i++) {
    var category = categories[i];
    var categoryName = category.id;
    var itemsContainer = category.nextElementSibling;
    var items = itemsContainer.querySelectorAll('.itemType li');

    for (var j = 0; j < items.length; j++) {
      var item = items[j];
      var itemName = item.getElementsByTagName('h3')[0].textContent;
      var countInput = item.getElementsByClassName('count')[0];
      var itemCount = parseInt(countInput.value);

      if (itemCount > 0) {
        if (!orderSummary[categoryName]) {
          orderSummary[categoryName] = [];
        }

        orderSummary[categoryName].push({
          name: itemName,
          count: itemCount
        });
      }
    }
  }

  return JSON.stringify(orderSummary);
}

async function submitOrder() {
  const order_summary = getOrderSummary();

  try {
    const response = await fetch("/order", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(order_summary),
    });

    if (response.ok) {
      alert("Thank you for your ordering!");
      const data = await response.json()
      window.location.href = data.location;
    } else {
      alert("Failed to submit order. Please try again.");
    }
  } catch (error) {
    console.error("Error ordering:", error);
  }
}


</script>
{% endblock %}
